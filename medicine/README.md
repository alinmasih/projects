# ğŸ’Š Medicine Tracker with Free WhatsApp Alerts

A **production-ready** system for tracking medicine intake with automated WhatsApp alerts to parents. Uses **free technologies** only: Flutter, Firebase, TensorFlow Lite, and whatsapp-web.js.

## ğŸ¯ Features

- **Flutter Android App** with live camera-only photo capture (anti-spoof)
- **ML-powered verification**: TensorFlow Lite on-device image embedding & matching
- **Firestore database** for user profiles, medicines, and logs
- **Firebase Storage** for medicine reference images
- **Firebase Cloud Messaging** for local push notifications
- **Node.js backend**: 24/7 WhatsApp bot using whatsapp-web.js
- **Free WhatsApp alerts** (no Twilio, no API costs)
- **Time-based medicine slots**: Morning, Afternoon, Night with configurable time ranges
- **Automatic missed-medicine detection**: Background scheduler marks medicines as missed
- **Cron-based WhatsApp notifications**: Parents get alerts for missed medicines

---

## ğŸ“‚ Project Structure

```
medicine/
â”œâ”€â”€ app/                          # Flutter app
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ main.dart            # App entry point
â”‚   â”‚   â”œâ”€â”€ firebase_options.dart # Auto-generated by flutterfire
â”‚   â”‚   â”œâ”€â”€ models/              # Data models (User, Medicine, MedicineLog)
â”‚   â”‚   â”œâ”€â”€ services/            # Firebase, ML, Notifications
â”‚   â”‚   â”œâ”€â”€ screens/             # UI screens
â”‚   â”‚   â””â”€â”€ widgets/             # Reusable widgets
â”‚   â”œâ”€â”€ android/                 # Android native config
â”‚   â”œâ”€â”€ pubspec.yaml             # Flutter dependencies
â”‚   â””â”€â”€ assets/
â”‚       â”œâ”€â”€ models/              # TensorFlow Lite model
â”‚       â””â”€â”€ labels/              # Model labels
â”‚
â”œâ”€â”€ server/                       # Node.js WhatsApp bot
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts             # Main entry point
â”‚   â”‚   â”œâ”€â”€ firebase.ts          # Firestore listener
â”‚   â”‚   â”œâ”€â”€ whatsapp.ts          # WhatsApp client
â”‚   â”‚   â””â”€â”€ logger.ts            # Logging
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ .env.example
â”‚
â”œâ”€â”€ ml_model/                    # TensorFlow model files
â”‚   â”œâ”€â”€ medicine_embedder.tflite # Pre-trained model
â”‚   â””â”€â”€ labels.txt               # Medicine class labels
â”‚
â”œâ”€â”€ scripts/                     # Helper scripts
â”‚   â”œâ”€â”€ start-bot.sh
â”‚   â”œâ”€â”€ flutter-run.sh
â”‚   â””â”€â”€ setup-firebase.sh
â”‚
â”œâ”€â”€ firestore.rules              # Firestore security rules
â”œâ”€â”€ storage.rules                # Firebase Storage security rules
â””â”€â”€ README.md                    # This file
```

---

## ğŸš€ Quick Start

### Prerequisites
- Flutter 3.0+ with Android SDK
- Node.js 18+
- Firebase project (free tier OK)
- WhatsApp account (for the bot)

### Step 1: Firebase Setup

1. **Create Firebase Project**
   ```bash
   # Go to https://console.firebase.google.com
   # Create new project (free tier)
   ```

2. **Enable Firestore**
   - Go to Firestore Database
   - Create database (production mode)
   - Location: Choose closest to you

3. **Enable Firebase Storage**
   - Go to Storage
   - Create bucket

4. **Enable Firebase Cloud Messaging**
   - Go to Cloud Messaging
   - Copy Server Key (for push notifications)

5. **Download Service Account Key**
   ```bash
   # Project Settings â†’ Service Accounts â†’ Generate Private Key
   # Save as server/firebase-credentials.json
   ```

### Step 2: Flutter Configuration

1. **Install FlutterFire CLI**
   ```bash
   dart pub global activate flutterfire_cli
   ```

2. **Configure Flutter for your Firebase project**
   ```bash
   cd app
   flutterfire configure
   # Select your Firebase project when prompted
   # This auto-generates lib/firebase_options.dart
   ```

3. **Download Android Google Services**
   ```bash
   # Firebase Console â†’ Project Settings â†’ Your Apps â†’ Android
   # Download google-services.json
   # Place in: android/app/google-services.json
   ```

4. **Install Flutter dependencies**
   ```bash
   flutter pub get
   ```

5. **Run the app**
   ```bash
   flutter run
   ```

### Step 3: Node.js Backend Setup

1. **Install dependencies**
   ```bash
   cd server
   npm install
   # or: yarn install
   ```

2. **Create .env file**
   ```bash
   cp .env.example .env
   # Edit .env with your paths
   ```

3. **Test WhatsApp login**
   ```bash
   npm run dev
   # QR code will appear in terminal
   # Scan with WhatsApp on your phone
   # Bot will authenticate and stay logged in
   ```

4. **Keep bot running 24/7**
   ```bash
   # Option 1: tmux/screen
   screen -S medicine-bot npm start
   
   # Option 2: systemd service (Linux)
   # Create: /etc/systemd/system/medicine-bot.service
   # See scripts/medicine-bot.service
   
   # Option 3: Docker
   docker build -t medicine-bot .
   docker run -d medicine-bot
   ```

### Step 4: Deploy Firestore Security Rules

```bash
# Install Firebase CLI
npm install -g firebase-tools

# Login to Firebase
firebase login

# Deploy rules
firebase deploy --only firestore:rules,storage:rules
```

---

## ğŸ“± App Usage

### 1. Sign In
- Enter User ID and Name
- App creates user profile in Firestore

### 2. Configure Medicine Slots
- **Home Screen** â†’ Click slot card
- Set time range (e.g., Morning: 8:00 AM - 10:00 AM)

### 3. Add Medicines (with ML Reference)
- **Home Screen** â†’ "Add Medicine"
- **Camera-only capture** (no gallery allowed)
- Take 3-5 photos from different angles
- ML extracts embeddings (vectors)
- Photos + embeddings saved to Firestore & Storage

### 4. Take Medicine (with Verification)
- At slot time, user gets notification
- Click "Take Medicine" button
- **Anti-spoof**: Capture with phone movement (3 frames)
- ML compares captured image against reference embeddings
- âœ… If match â†’ Mark as taken, send parent notification
- âŒ If no match â†’ Retry or skip

### 5. Missed Medicine Alert
- If slot time expires and medicine not taken:
  - Firestore marks `missed=true`
  - Node.js bot detects change
  - **Sends WhatsApp alert to parent**:
    ```
    ğŸš¨ Medicine Alert
    
    Alin did NOT take Morning Medicine between 8:00-10:00 AM
    
    Please remind them to take their medicine.
    ```

### 6. View History
- **Home Screen** â†’ "View History"
- See all medicine logs (taken/missed/whatsapp sent)

### 7. Update Parent Phone
- **Settings** â†’ Enter WhatsApp phone number
- Must include country code (e.g., +1234567890)

---

## ğŸ¤– ML Model Setup

### Using Pre-trained Model

Download a pre-trained MobileNetV2 or EfficientNet model for image embedding:

```bash
# Option 1: Use a pre-trained embedder model
# Download from: https://tfhub.dev/
# Choose a model that outputs embeddings (128-512D vectors)

# Place in: app/assets/models/medicine_embedder.tflite

# Update in lib/services/ml_service.dart:
# _INPUT_SIZE = 224  # Model input dimensions
# _EMBEDDING_SIZE = 128  # Output embedding size
# _SIMILARITY_THRESHOLD = 0.75  # Confidence threshold
```

---

## ğŸ” Firestore Database Schema

```
users/{userId}
  â”œâ”€â”€ id: string
  â”œâ”€â”€ name: string
  â”œâ”€â”€ parentPhone: string ("+1234567890")
  â”œâ”€â”€ slots: {
  â”‚   "morning": {
  â”‚     name: "morning"
  â”‚     startTime: "08:00"
  â”‚     endTime: "10:00"
  â”‚     medicines: [
  â”‚       {
  â”‚         id: "uuid"
  â”‚         name: "Aspirin 500mg"
  â”‚         imageUrls: ["storage_url_1", "storage_url_2", ...]
  â”‚         embeddings: [[0.1, 0.2, ...], [...], ...]
  â”‚         createdAt: timestamp
  â”‚       },
  â”‚       ...
  â”‚     ]
  â”‚   },
  â”‚   "afternoon": {...},
  â”‚   "night": {...}
  â”‚ }
  â”œâ”€â”€ createdAt: timestamp
  â””â”€â”€ updatedAt: timestamp

medicineLogs/{logId}
  â”œâ”€â”€ id: string
  â”œâ”€â”€ userId: string
  â”œâ”€â”€ slot: string ("morning", "afternoon", "night")
  â”œâ”€â”€ taken: boolean (user took medicine + ML verified)
  â”œâ”€â”€ timestamp: timestamp (when taken)
  â”œâ”€â”€ missed: boolean (auto-set if not taken by end time)
  â”œâ”€â”€ whatsappSent: boolean (alert sent to parent)
  â”œâ”€â”€ createdAt: timestamp
  â””â”€â”€ updatedAt: timestamp
```

---

## ğŸ”” Local Notifications

The app uses `flutter_local_notifications` to:
- Notify user at slot start time (e.g., 8:00 AM)
- Daily recurring notifications
- Sound + vibration

---

## ğŸ¤– WhatsApp Bot (Node.js Backend)

### Flow
1. **Initialize**: Load Firebase credentials & WhatsApp session
2. **QR Login**: First run, scan QR code with WhatsApp phone
3. **Stay Logged In**: whatsapp-web.js persists session locally
4. **Listen**: Watch Firestore for `missed=true && whatsappSent=false`
5. **Send**: Compose & send WhatsApp message to parent
6. **Mark Sent**: Update Firestore `whatsappSent=true` (prevents duplicates)

### Example Message
```
ğŸš¨ Medicine Alert

Alin did NOT take Morning Medicine between 8:00-10:00 AM

Please remind them to take their medicine.
```

---

## ğŸ›¡ï¸ Security

### Firestore Rules
- Users can only read/write their own data
- Medicine logs are user-scoped
- Validation on medicine and log documents

### Storage Rules
- Users can only upload to `medicines/{userId}/...`
- 5MB file size limit per image
- Only image MIME types allowed

---

## ğŸ“Š Testing

### Test Scenario 1: Add Medicine
1. Sign in with test user
2. Configure morning slot (8:00-10:00)
3. Tap "Add Medicine"
4. Capture 3 photos of a pill bottle
5. Name: "Test Medicine"
6. Verify photos uploaded to Storage

### Test Scenario 2: Take Medicine
1. Tap "Take Medicine"
2. Capture live photo with motion
3. Verify ML matches reference embeddings
4. Check `medicineLogs` in Firestore

### Test Scenario 3: Missed Medicine Alert
1. Configure slot ending at 9:00 AM
2. Don't take medicine
3. After 9:00 AM, manually set `missed=true` in Firestore
4. Check WhatsApp bot logs
5. Verify alert sent to parent phone

---

## ğŸ“ˆ Deployment

### Flutter (Android)
```bash
cd app
flutter build apk --release
# Output: app/build/app/outputs/apk/release/app-release.apk
```

### Node.js Backend (Linux/Raspberry Pi)

**Option 1: PM2**
```bash
npm install -g pm2
pm2 start "npm start" --name medicine-bot
pm2 save
pm2 startup
```

**Option 2: Systemd Service**
```bash
sudo systemctl enable medicine-bot
sudo systemctl start medicine-bot
```

---

## ğŸ’¡ Tips for Production

1. Use Firebase Authentication instead of simple user ID
2. Implement rate limiting on WhatsApp sending
3. Set up CloudWatch logging for bot monitoring
4. Test on real devices before deployment
5. Enable Firestore backups daily

---

**Built with â¤ï¸ using Flutter, Firebase, TensorFlow Lite, and whatsapp-web.js**

*Zero API costs. 100% free. Open source.*
